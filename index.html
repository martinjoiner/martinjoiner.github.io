<!DOCTYPE html>
<html>
<head>

    <title>Ferries - An urban transport visualisation experiment by Martin Joiner and Nic Price</title>

    <meta name='viewport' content='initial-scale=1,maximum-scale=1,user-scalable=no' />
    <script src='https://api.mapbox.com/mapbox.js/v2.2.3/mapbox.js'></script>
    
    <link href='https://api.mapbox.com/mapbox.js/v2.2.3/mapbox.css' rel='stylesheet' />
    <link href='/css/style.css' rel='stylesheet' />

</head>
<body>

    <div id='map'></div>
    
    <!-- This file contains the definition of 'routes' variable -->
    <script src="/js/routes.js"></script>

    <script>


        // Iterates over all the legs in a route making latlngs and totalling distance
        function processLegs( legs ){
            var keys = Object.keys( legs ),
                key;
            for( var i = 0, iLimit = keys.length; i < iLimit; i++ ){
                key = keys[i];
                processLeg(legs[key]);
            }
        }


        function processLeg( leg ){
            var totalDistance = 0;
            var line = [];
            for( var i = 0, iLimit = leg.points.length; i < iLimit; i++ ){
                addLatlngToPoint(leg.points[i]);
                // Add the latlng to the line
                line.push( leg.points[i].latlng );
                // Set the distance to this point, for the previous point
                if( i > 0 ){
                    leg.points[i-1].distanceToNext = leg.points[i-1].latlng.distanceTo( leg.points[i].latlng );
                    totalDistance += leg.points[i-1].distanceToNext;
                }
            }
            leg.totalDistance = totalDistance;
            // Save the line ready to make a polyline later
            leg.line = line;
        }

        // Takes a point object and adorns it with a glorious latlng object
        function addLatlngToPoint( point ){
            point.latlng = L.latLng(point.lat, point.lng);
        }

        processLegs( routes.west.legs );



        // Draw the map -------------------------------------------------------- //
        // --------------------------------------------------------------------- //

        L.mapbox.accessToken = 'pk.eyJ1IjoibWFydGluam9pbmVyIiwiYSI6ImNpaTh0Z2U0YzAwa3R0am0zbG91eXNjbGsifQ.qHn0qCslolUYqah6LM8OPw';
        var map = L.mapbox.map('map', 'examples.map-zr0njcqy')
                  .setView([51.4505481,-2.6002987], 15);

        var polyline_options = {
            color: '#000'
        };

        // Prints a polyline for each leg of a route
        function showRouteOnMap( route ){
            var polylines = [],
                cnt = 0;
            for( var leg in route.legs ){
                // Add a polyline for each
                polylines[cnt] = L.polyline(route.legs[leg].line, polyline_options).addTo(map);
                cnt++;
            }

        }
        showRouteOnMap( routes.west );

    </script>
</body>
</html>
